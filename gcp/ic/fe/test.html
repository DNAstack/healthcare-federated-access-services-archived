<!--
 Copyright 2019 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
  <head>
    <style>
      h3 .small {
        font-size: 12px;
      }
      .btn {
        display: inline-block;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        border: 1px solid transparent;
        padding: .375rem .75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: .25rem;
        text-decoration: none;
        cursor: pointer;
        font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
        margin: 10px;
      }
      .blue {
        background: #007bff;
        color: white;
      }
      .white {
        color: #666;
        border: 1px solid #bbb;
      }
      .white:hover {
        color: #333;
        border: 1px solid #888;
      }
      .black {
        color: #ddd;
        background: #222;
      }
      .black:hover {
        color: #fff;
        background: #000;
      }
      .red {
        color: #fff;
        background: #dc3545;
      }
      .red:hover {
        color: #fff;
        background: #c82333;
      }
      .box {
        margin: 20px 0 20px 0;
      }
      pre {
        border: 1px solid #888;
        background: #eee;
      }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
      var clientId = "903cfaeb-57d9-4ef6-5659-04377794ed65";
      var clientSecret = "48f7e552-d9b7-42f3-ba76-e5ab5b3c70ab";
      var loginURL = "/identity/v1alpha/_REALM_/authorize?scope=_SCOPE_&response_type=code&client_id="+clientId+"&redirect_uri=_REDIRECT_"
      var passportURL = "/identity/v1alpha/_REALM_/token?grant_type=authorization_code&redirect_uri=_REDIRECT_&code=_AUTH_CODE_&client_id="+clientId+"&client_secret="+clientSecret;
      var refreshURL = "/identity/v1alpha/_REALM_/token?grant_type=refresh_token&refresh_token=_REFRESH_TOKEN_&client_id="+clientId+"&client_secret="+clientSecret;
      var revokeURL = "/identity/v1alpha/_REALM_/revoke";
      var resourceResp = null;
      var workspace = "";
      var resourcesURL = "_DAM_URL_/dam/v1alpha/_REALM_/resources?client_id="+clientId+"&client_secret="+clientSecret;
      var resourceURL = "_DAM_URL_/dam/v1alpha/_REALM_/resources/_RESOURCE_/views/_VIEW_/roles/_ROLE_/token?access_token=_TOKEN_&client_id="+clientId+"&client_secret="+clientSecret;
      var accountURL = "/identity/v1alpha/_REALM_/accounts/-?client_id="+clientId+"&client_secret="+clientSecret;
      var damCfgURL = "_DAM_URL_/dam/v1alpha/_REALM_/config?access_token=_TOKEN_&client_id="+clientId+"&client_secret="+clientSecret;
      var linkURL = "/identity/v1alpha/_REALM_/accounts/_ACCOUNT_?link_token=_LINK_TOKEN_&client_id="+clientId+"&client_secret="+clientSecret;
      var refreshToken = null;
      var defaultScopes = "openid ga4gh profile account_admin";
      var resources = {};

      function init() {
        var params = new URLSearchParams(window.location.search);
        var code = params.get('code');
        var linked = params.get('linked');
        if (code) {
          $("#login_auth").val(code);
        }
        var scope = params.get('scope');
        if (scope) {
          $('#scope').val(scope);
        }
        if (linked && code && scope) {
          linkAccounts(linked, code, scope);
        }
        var damUrl = $("#dam_url").val();
        if (damUrl.includes("//localhost:")) {
          var port = new URL(damUrl).port;
          damUrl = `${window.location.protocol}//${window.location.hostname}:${port}`;
          $("#dam_url").val(damUrl);
        }
        populateResources();
      }

      // set scope for login and getPassport
      function setScope() {
        var scope = $('#scope').val();
        if (!scope.startsWith("link") && scope.length > 0) {
          return;
        }
        var params = new URLSearchParams(window.location.search);
        scope = params.get('scope');
        if (!scope || scope.length === 0) {
          scope = defaultScopes;
        }
        $('#scope').val(scope);
      }

      function getPassport(successAction) {
        var token = $("#login_auth").val();
        if (!token) {
          $("#source").text("must login first...");
          return;
        }
        var url = makeURL(passportURL, token);
        $.ajax({
          url: url,
          type: "POST",
          beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'bearer ' + token);},
          success: function(resp) {
            console.log("Authorization: " + JSON.stringify(resp, undefined, 2));
            $("#passport").val(resp.access_token);
            if (resp.refresh_token) {
              refreshToken = resp.refresh_token;
            }
            successAction && successAction(resp)
          },
          error: function(err) {
            $("#source").text(JSON.stringify(err, undefined, 2));
          }
        });
      }
      function resolvePassport(successAction) {
        var passport = $('#passport').val();
        if (passport) {
          successAction(passport);
          return
        }
        getPassport(function(resp) {
          successAction(resp.access_token);
        });
      }
      function refreshPassport() {
        if (!refreshToken) {
          $("#source").text("must fetch passport first...");
          return;
        }
        var url = makeURL(refreshURL, refreshToken)
        $.ajax({
          url: url,
          type: "POST",
          success: function(resp) {
            console.log("Authorization: " + JSON.stringify(resp, undefined, 2))
            $("#passport").val(resp.access_token);
            displaySuccess("passport token has been refreshed");
          },
          error: function(err) {
            $("#source").text(JSON.stringify(err, undefined, 2));
          }
        });
      }
      function revokeRefreshToken() {
        if (!refreshToken) {
          $("#source").text("must fetch passport first...");
          return;
        }
        var url = makeURL(revokeURL, refreshToken)
        $.ajax({
          url: url,
          type: "POST",
          data: {
            "token": refreshToken,
            "client_id": clientId,
            "client_secret": clientSecret
          },
          success: function(resp) {
            displaySuccess("refresh token has been successfully revoked");
          },
          error: function(err) {
            $("#source").text(JSON.stringify(err, undefined, 2));
          }
        });
      }
      function makeURL(pattern, token, params) {
        var path = window.location.pathname;
        var redirect = (params && path+"?"+params) || path;
        var realm = path.split('/')[3];  // first character is a slash...
        return pattern.replace(/_PATH_/g, encodeURI(path))
                      .replace(/_AUTH_CODE_/g, encodeURIComponent(token))
                      .replace(/_REFRESH_TOKEN_/g, encodeURIComponent(refreshToken))
                      .replace(/_REALM_/g, encodeURIComponent(realm))
                      .replace(/_REDIRECT_/g, encodeURIComponent(redirect))
                      .replace(/_RESOURCE_/g, encodeURIComponent($("#resource_name").val()))
                      .replace(/_VIEW_/g, encodeURIComponent($("#resource_view").val()))
                      .replace(/_ROLE_/g, encodeURIComponent($("#resource_role").val()))
                      .replace(/_DAM_URL_/g, encodeURI($("#dam_url").val()))
                      .replace(/_TOKEN_/g, encodeURIComponent($("#passport").val()))
                      .replace(/_SCOPE_/g, encodeURIComponent($('#scope').val()));
      }
      function jwt(id) {
        var token = $("#"+id).val();
        window.open("https://jwt.io/#debugger-io?token="+token);
      }
      function login() {
        setScope();
        var url = makeURL(loginURL);
        window.location.href = url;
      }
      function link() {
        var scope = $('#scope').val();
        var params = new URLSearchParams(window.location.search);
        var code = params.get('code');
        var linked = params.get('linked');
        if (scope.includes("link") && !scope.includes("link:") && code) {
          resolvePassport(function(passport) {
            // Lookup the account ID for the link.
            accountInfo(function(resp) {
              scope = "openid link:"+resp.account.properties.subject;
              $('#scope').val(scope);
              var url = makeURL(loginURL, "", "scope="+encodeURIComponent(scope)+"&linked="+encodeURIComponent(passport));
              window.location.href = url;
            });
          });
        } else if (scope.includes("link:") && linked) {
          var url = makeURL(loginURL, "", "scope="+encodeURIComponent(scope)+"&linked="+encodeURIComponent(passport));
          window.location.href = url;
        } else {
          scope = "openid link"
          $('#scope').val(scope);
          var url = makeURL(loginURL, "", "scope="+encodeURIComponent(scope));
          window.location.href = url;
        }
      }
      function accountInfo(successAction) {
        var token = $("#passport").val();
        if (!token) {
          $("#source").text("must fetch passport first...");
          return;
        }
        var url = makeURL(accountURL);
        $.ajax({
          url: url,
          type: "GET",
          beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'bearer ' + token);},
          success: successAction,
          error: function(xhr, status, err) {
            displayResult(xhr.responseText || xhr);
          }
        });
      }
      function linkAccounts(linked, code, scope) {
        if (history.pushState) {
          var uri = window.location.pathname + '?scope='+encodeURIComponent(scope)+'&linked='+encodeURIComponent(linked);
          history.pushState(null, '', uri)
        }
        var link = scope.split("link:")
        if (link.length != 2) {
          displayError("scope information incorrect for linking accounts...")
        }
        console.log(`LINKING: attempting to link account to "${link[1]}"`);
        getPassport(function(resp) {
          var acct = link[1].split(" ")[0]
          var url = linkURL.replace(/_ACCOUNT_/g, encodeURIComponent(acct))
                           .replace(/_LINK_TOKEN_/g, encodeURIComponent(resp.access_token))
          url = makeURL(url)
          $.ajax({
            url: url,
            type: "PATCH",
            beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'bearer ' + linked);},
            success: function(resp) {
              displaySuccess("accounts are now linked");
            },
            error: function(xhr, status, err) {
              displayResult(xhr.responseText || xhr);
            }
          });
        });
      }
      function populateResources() {
        $.ajax({
          url: makeURL(resourcesURL),
          type: "GET",
          success: function(resp) {
            resources = {};
            for (var resName in resp.resources) {
              var res = resp.resources[resName];
              var views = {};
              for (var viewName in res.views) {
                var view = res.views[viewName];
                var roles = [];
                for (var role in view.roles) {
                  roles.push(role)
                }
                views[viewName] = roles;
              }
              resources[resName] = views;
            }
            setupResources();
          },
          error: function(xhr, status, err) {
            setupResources();
          }
        });
      }
      function setupResources() {
        if (jQuery.isEmptyObject(resources)) {
          resources = {
            "thousand-genomes": {
              "discovery-access": ["discovery"],
              "gcs-file-access": ["viewer"]
            }
          };
        }
        populateDropdown('resource_name', Object.keys(resources));
        resourceChanged();
      }
      function populateDropdown(id, values) {
        var html = '';
        for (var i = 0; i < values.length; i++) {
          html += `<option val="${values[i]}">${values[i]}</option>`;
        }
        $('#'+id).html(html).val($(`#${id} option:first`).val());
      }
      function getResource() {
        var url = makeURL(resourceURL);
        var passport = $("#passport").val();
        if (!passport) {
          $("#source").text("must get a passport first...");
          return;
        }
        var hasStatus = false;
        $.ajax({
          url: url,
          type: "GET",
          beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'bearer ' + passport);},
          success: function(resp) {
            $("#resource").text(resp.token);
            var inter = resp.view.interfaces["http:gcp:gs"] || {};
            var url = (inter.uri && inter.uri.length && inter.uri[0]) || "";
            $("#dataset_url").val(url.length ? url+"/o/" + "?access_token=" + resp.token : "");
            $("#source").text(JSON.stringify(resp, undefined, 2));
          },
          statusCode: {
            401: function() {
              hasStatus = true;
              $("#source").text("unauthorized");
            },
            403: function() {
              hasStatus = true;
              $("#source").text("forbidden");
            },
            503: function() {
              hasStatus = true;
              $("#source").text("service unavailable");
            }
          },
          error: function(xhr, status, err) {
            displayResult(xhr.responseText || xhr);
          }
        });
      }
      function browseDataset() {
        var url = $("#dataset_url").val();
        if (!url) {
          $("#source").text("get a token first...");
          return;
        }
        $.ajax({
          url: url,
          type: "GET",
          success: displayResult,
          error: displayResult
        });
      }
      function damConfig() {
        fetchAuthURL(damCfgURL);
      }
      function fetchAuthURL(urlFmt) {
        var url = makeURL(urlFmt);
        var passport = $("#passport").val();
        if (!passport) {
          $("#source").text("must get a passport first...");
          return;
        }
        $.ajax({
          url: url,
          type: "GET",
          beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'bearer ' + passport);},
          success: function(resp) {
            displayResult(resp || "[empty response]")
          },
          error: function(xhr, status, err) {
            displayResult(xhr.responseText || xhr);
          }
        });
      }
      function displayResult(result) {
        $("#source").text(JSON.stringify(result, undefined, 2));
      }
      function displaySuccess(str) {
        $("#source").text(str);
      }
      function displayError(str) {
        $("#source").text(str);
      }
      function clearPage() {
        window.location.href = makeURL("_PATH_");
      }
      function resourceChanged() {
        var val = $('#resource_name').val();
        var list = Object.keys(resources[val]);
        populateDropdown('resource_view', list);
        viewChanged();
      }
      function viewChanged() {
        var val = $('#resource_view').val();
        var list = resources[$('#resource_name').val()][val];
        populateDropdown('resource_role', list);
      }
    </script>
  </head>
  <body onload="init()">
    <h1>Identity Concentrator Test</h1>
    <div class="box">
      <h3>Login Authentication Code</h3>
      <textarea id="login_auth" rows="4" style="width:100%" readonly></textarea>
      <div>
        <a class="btn blue" onclick="login()">Login</a>
        <a class="btn black" onclick="link()">Link Accounts</a>
        <a class="btn white" onclick="jwt('login_auth')">JWT.IO</a>
        <a class="btn white" onclick="clearPage()">Clear</a>
        <input id="scope" type="text" value="">
      </div>
    </div>
    <div class="box">
      <h3>Access Token <span class="small">(Passport when it has "ga4gh" scope)</span></h3>
      <textarea id="passport" rows="7" style="width:100%" readonly></textarea>
      <div>
        <a class="btn blue" onclick="getPassport()">Passport</a>
        <a class="btn black" onclick="refreshPassport()">Refresh Passport</a>
        <a class="btn red" onclick="revokeRefreshToken()">Revoke Refresh</a>
        <a class="btn white" onclick="accountInfo(displayResult)">Account Info</a>
        <a class="btn white" onclick="jwt('passport')">JWT.IO</a>
      </div>
    </div>
    <div class="box">
      <h3>DAM Resource</h3>
      <input id="dam_url" style="width:100%" value="${DAM_URL}" onchange="populateResources()">
      <select id="resource_name" style="width:33%" onchange="resourceChanged()"></select>
      <select id="resource_view" style="width:33%" onchange="viewChanged()"></select>
      <select id="resource_role" style="width:33%"></select>
      <div><textarea id="resource" rows="7" style="width:100%" readonly></textarea></div>
      <div><textarea id="dataset_url" rows="7" style="width:100%" readonly></textarea></div>
      <div>
        <a class="btn blue" onclick="getResource()">Resource Token</a>
        <a class="btn black" onclick="browseDataset()">Browse Resource</a>
        <a class="btn black" onclick="damConfig()">DAM Config</a>
        <a class="btn white" onclick="jwt('resource')">JWT.IO</a>
        <a class="btn white" onclick="$('#dam_url').val('http://localhost:8081');">Local DAM</a>
      </div>
      <pre id="source"></pre>
    </div>
  </body>
</html>
